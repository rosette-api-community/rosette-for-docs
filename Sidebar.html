
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <!-- The CSS package above applies Google styling to buttons and other elements. -->
  
  <style>
  .branding-below {
    bottom: 56px;
    top: 0;
  }
  
  .branding-text {
    left: 7px;
    position: relative;
    top: 3px;
  }
  
  h5.PERSON{
    color: #E93824;
    }
    
  h5.LOCATION {
    color: #2CAAE2;
    }
    
    h5.ORGANISATION {
    color: #FEC238;
    }
  
  .col-contain {
    overflow: hidden;
  }
  
  .col-one {
    float: left;
    width: 50%;
  }
  
  .logo {
    vertical-align: middle;
  }
  
  .radio-spacer {
    height: 20px;
  }
  
  .width-100 {
    width: 100%;
  }
  </style>
</head>
<body>
  <div class="sidebar branding-below">
    <img src="https://s3.amazonaws.com/rosette-api/rosette-logo.jpg" style="width:250px;"/>
    <div class="block">
      <input type="checkbox" id="save-prefs">
      <label for="save-prefs">Save selections</label>
    </div>
    <div class="block col-contain">
      <div>
        <label for="key"> API Key</label>
        <input type="text" name="key" id="key">
      </div>
    </div>
    <br>
    
         <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#entities" aria-controls="entities" role="tab" data-toggle="tab">Entities</a></li>
    <li role="presentation"><a href="#wiki" aria-controls="wiki" role="tab" data-toggle="tab">Wiki</a></li>
  </ul>
  
   <!-- Tab panes --> 
   <div class="tab-content"> <div role="tabpanel" class="tab-pane active" id="entities">
  <br>
  <div class="block">
  <div>
  Before running, <a href = "https://support.google.com/docs/answer/65166?hl=en">ensure text direction is correct</a>
  </div>
  <br>
  <label for="sourceLang">Source Language (optional)</label>
  <div>
  <select id="sourceLang" name="sourceLang" class="form-control col-sm-2">
  <option value="auto">Auto</option>
  <option value="ara">Arabic</option>
  <option value="zho">Chinese</option>
  <option value="nld">Dutch</option>
  <option value="eng">English</option>
  <option value="fra">French</option>
  <option value="deu">German</option>
  <option value="heb">Hebrew</option>
  <option value="ind">Indonesian</option>
  <option value="ita">Italian</option>
  <option value="jpn">Japanese</option>
  <option value="kor">Korean</option>
  <option value="pus">Pashto</option>
  <option value="fas">Persian</option>
  <option value="por">Portugese</option>
  <option value="rus">Russian</option>
  <option value="spa">Spanish</option>
  <option value="urd">Urdu</option>
  </select>
  </div>
  
  <br>

  <label for="targetLang">Target Language</label>
  <div>
  <select id="targetLang" name="targetLang" class="form-control">
  <option value="ara">Arabic</option>
  <option value="zho">Chinese</option>
  <option value="nl">Dutch</option>
  <option value="eng">English</option>
  <option value="fr">French</option>
  <option value="de">German</option>
  <option value="he">Hebrew</option>
  <option value="id">Indonesian</option>
  <option value="it">Italian</option>
  <option value="ja">Japanese</option>
  <option value="kor">Korean</option>
  <option value="pus">Pashto</option>
  <option value="fas">Persian</option>
  <option value="pt">Portugese</option>
  <option value="rus">Russian</option>
  <option value="es">Spanish</option>
  <option value="ur">Urdu</option>
  </select>
  </div>
  </div>
  
  <br>

<label>Insert translation</label>
<div class="block">
<input type="checkbox" id="insertPerson">
<label style="color:#E93824;" for="insertPerson">Person</label>
<div style="font-size:12px;" id="peopleDiv">
</div>
</div>

<div class="block">
<input type="checkbox" id="insertLocation">
<label style="color:#2CAAE2;" for="insertLocation">Location</label>
<div style="font-size:12px;" id="locDiv">
</div>
</div>

<div class="block">
<input type="checkbox" id="insertOrganisation">
<label style="color:#FEC238;" for="insertOrganisation">Organization</label>
<div style="font-size:12px;" id="orgDiv">
</div>
</div>

<br>

<div class="block" id="button-bar">
<button class="blue" id="run-analysis">Analyze</button>
</div>

<div class="block form-group">
<p id="loading"></p>
</div>

  <div class="block form-group">        
  <textarea style="display:none;" class="width-100" id="translated-text" rows="10"></textarea>    
</div>

</div>

    <div role="tabpanel" class="tab-pane" id="wiki">

      <br>
        <div class="block">
  <label for="sourceLangWiki">Source Language (optional)</label>
  <div>
  <select id="sourceLangWiki" name="sourceLangWiki" class="form-control col-sm-2">
  <option value="auto">Auto</option>
  <option value="ara">Arabic</option>
  <option value="zho">Chinese</option>
  <option value="eng">English</option>
  <option value="spa">Spanish</option>
  </select>
  </div>
  </div>
  <br>
      <div class="block" id="button-bar">
        <button class="blue" id="get-wiki">Get wiki data</button>
        <button class="blue" id="clear-wiki">Clear</button>
      </div>
       
    <br> 
         <div id="titlepanel">
  </div>
  <div id="datapanel">
  </div>
  <div id="paragraphpanel">
  </div>
      <br> 
     <div id="titlepanel2">
  </div>
  <div id="datapanel2">
  </div>
  <div id="paragraphpanel2">
  </div>
  <br>
    <div class="block" id="wiki-error">
      </div>
   </div> 

</div>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js">
</script>

<!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  
<script>
/**
* On document load, assign click handlers to each button and try to load the
* user's origin and destination language preferences if previously set.
*/
$(function() {
  $('#get-wiki').click(getWikiData);
  $('#run-analysis').click(runEntityExtraction);
  $('#run-analysis').click(orientDocument);
  $('#clear-wiki').click(clearWikiSpace);
});

/**
* Callback function that populates the origin and destination selection
* boxes with user preferences from the server.
*
* @param {Object} languagePrefs The saved origin and destination languages.
*/
function loadNameTranslationPreferences(userPrefs) {
  $('#key').val(userPrefs.key);
  $('#sourceLang').val(userPrefs.sourceLanguage);
  $('#targetLang').val(userPrefs.targetLanguage);
  $('#insertPerson').prop("checked", userPrefs.insertPerson);
  $('#insertLocation').prop("checked", userPrefs.insertLocation);
  $('#insertOrganisation').prop("checked", userPrefs.insertOrganisation);
  $('#sourceLangWiki').val(userPrefs.sourceLangWiki);
}

function orientDocument(){
  this.disabled = true;
  var sourceLang = $('#sourceLang').val();
  google.script.run.documentOrientation(sourceLang);
  this.disabled = false;}

/**
* Runs a server-side function to translate the user-selected text and update
* the sidebar UI with the resulting translation.
*/
function admResults() {
  this.disabled = true;
  $('#error').remove();
  var key = $('#key').val();
  var savePrefs = $('#save-prefs').is(':checked');
  google.script.run
  .withSuccessHandler(
    function(translatedText, element) {
      $('#translated-text').val(translatedText);
      var JSONobj = JSON.parse(translatedText);
      try{
      var entitiesArray = JSONobj["attributes"]["entityMentions"]["items"];
      for (var entCount = 0; entCount < entitiesArray.length; entCount++) {
        google.script.run.colorText(entitiesArray[entCount]["normalized"], entitiesArray[entCount]["entityType"]);
        }
      nameInsertion();
      google.script.run.withSuccessHandler(loadNameTranslationPreferences).withFailureHandler(showError).getPreferences();
       }
       catch(err){
       $('#translated-text').val(null);
       notLinkedInsertion();
       }
       
    })
    .withFailureHandler(
      function(msg, element) {
        showError(msg, $('#button-bar'));
        element.disabled = false;
      })
      .withUserObject(this)
      .admResults(key, savePrefs);
}
    
    
 /**
  * Runs a server-side function to insert the translated text into the document
  * at the user's cursor or selection.
  */
  function nameInsertion() {
    this.disabled = true;
    $('#error').remove();
    var key = $('#key').val();
    var sourceLanguage = $('#sourceLang').val();
    var targetLanguage = $('#targetLang').val();
    var insertPers = $('#insertPerson').is(':checked');
    var insertLoc = $('#insertLocation').is(':checked');
    var insertOrg = $('#insertOrganisation').is(':checked');
    var savePrefs = $('#save-prefs').is(':checked');
    google.script.run
    .withSuccessHandler(
      function(returnSuccess, element) {
        
        $('#loading').text('');
        element.disabled = false;
      })
      .withFailureHandler(
        function(msg, element) {
        $('#loading').text('');
          showError(msg, $('#button-bar'));
          element.disabled = false;
        })
        .withUserObject(this)
        .nameInsertion(key, $('#translated-text').val(), sourceLanguage, targetLanguage, insertPers, insertLoc, insertOrg, savePrefs,true);
  }
 
 function notLinkedInsertion() {
    this.disabled = true;
    $('#error').remove();
    var key = $('#key').val();
    var sourceLanguage = $('#sourceLang').val();
    var targetLanguage = $('#targetLang').val();
    var insertPers = $('#insertPerson').is(':checked');
    var insertLoc = $('#insertLocation').is(':checked');
    var insertOrg = $('#insertOrganisation').is(':checked');
    var savePrefs = $('#save-prefs').is(':checked');
    google.script.run
    .withSuccessHandler(
      function(entities, element) {

        $('#loading').text('');
        element.disabled = false;
        
      })
      .withFailureHandler(
        function(msg, element) {
          $('#loading').text('');
          showError(msg, $('#button-bar'));
          element.disabled = false;
        })
        .withUserObject(this)
        .notLinkedInsertion(key, sourceLanguage, targetLanguage, insertPers, insertLoc, insertOrg, savePrefs);
  }
      
   /**
    * Runs a server-side function to translate the user-selected text and update
    * the sidebar UI with the resulting translation.
    */
    function runEntityExtraction() {
      $('#loading').text('Processing...');
      $('#peopleDiv').html("");
      $('#locDiv').html("");
      $('#orgDiv').html("");
      $('#error').remove();

      google.script.run
        .withSuccessHandler(
          function(anotatedText) {
            var JSONobj = JSON.parse(anotatedText);
            var entitiesArray = JSONobj.entities;
            console.log(entitiesArray);
            var orgString = "";
            var natString = "";
            var titleString = "";
            var insertPers = $('#insertPerson').is(':checked');
            var insertLoc = $('#insertLocation').is(':checked');
            var insertOrg = $('#insertOrganisation').is(':checked');
            var targetLanguage = $('#targetLang').val();
            var sourceLanguage = $('#sourceLang').val();
            for (var entCount = 0; entCount < entitiesArray.length; entCount++)
            {
              google.script.run.colorText (entitiesArray[entCount].mention, entitiesArray[entCount].type);
              var originalNameObj = new Object;
              originalNameObj["name"] = entitiesArray[entCount].mention;
              switch (entitiesArray[entCount].type)
              {
                case "PERSON":
                google.script.run
                  .withSuccessHandler(function(NAMEobj) {
                    var peopleString = $('#peopleDiv').html();
                    //peopleString = peopleString + NAMEobj.originalName + ' (' + NAMEobj.translation+")<br/> ";
                    peopleString = peopleString + NAMEobj+"<br/>";
                    $('#peopleDiv').html(peopleString);
                    }
                  )
                  .withFailureHandler(function(msg, element) {
                    var peopleString = $('#peopleDiv').html();
                    peopleString = peopleString + element.name + ' (no_translation)' + '<br/>';
                    $('#peopleDiv').html(peopleString);
                    }
                  )
                  .withUserObject(originalNameObj)
                  .runNameTranslationGS (entitiesArray[entCount].mention, entitiesArray[entCount].type, $('#key').val(), sourceLanguage, targetLanguage);
                break;
                case "LOCATION":
                google.script.run
                  .withSuccessHandler(function(NAMEobj) {
                    var locString = $('#locDiv').html();
                    //locString = locString + NAMEobj.originalName + ' (' + NAMEobj.translation+")<br/> ";
                    locString = locString + NAMEobj+"<br/>";
                    $('#locDiv').html(locString);
                    }
                  )
                  .withFailureHandler(function(msg, element) {
                    var locString = $('#locDiv').html();
                    locString = locString + element.name + ' (no_translation)' + '<br/>';
                    $('#locDiv').html(locString);
                    }
                  )
                  .withUserObject(originalNameObj)
                  .runNameTranslationGS (entitiesArray[entCount].mention, entitiesArray[entCount].type, $('#key').val(), sourceLanguage, targetLanguage);
                break;
                case "ORGANIZATION":
                  google.script.run
                  .withSuccessHandler(function(NAMEobj) {
                    var orgString = $('#orgDiv').html();
                    //orgString = orgString + NAMEobj.originalName + ' (' + NAMEobj.translation+")<br/> ";
                    orgString = orgString + NAMEobj+"<br/>";
                    $('#orgDiv').html(orgString);
                    }
                  )
                  .withFailureHandler(function(msg, element) {
                    var orgString = $('#orgDiv').html();
                    orgString = orgString + element.name + ' (no_translation)'+ '<br/>';
                    $('#orgDiv').html(orgString);
                    }
                  )
                  .withUserObject(originalNameObj)
                  .runNameTranslationGS (entitiesArray[entCount].mention, entitiesArray[entCount].type, $('#key').val(), sourceLanguage, targetLanguage);
                break;
              }
            }
            admResults();
            //$('#loading').text('');
          })
        .withFailureHandler(
          function(msg, element) {
            showError(msg, $('#error-box'));
            this.disabled = false;
            $('#loading').text('');
          }).withUserObject(this)
        .runEntityExtractionGS($('#key').val());
    }
    
      
  /**
  * Inserts a div that contains an error message after a given element.
  *
  * @param msg The error message to display.
  * @param element The element after which to display the error.
  */
  function showError(msg, element) {
    var div = $('<div id="error" class="error">' + msg + '</div>');
    $(element).after(div);
    $('#loading').text('');
  }
  
  /**
    * Runs a server-side function to translate the user-selected text and update
    * the sidebar UI with the resulting translation.
    */
    function getWikiData() {
      this.disabled = true;
      $('#error').remove();
      var sourceLangWiki = $('#sourceLangWiki').val();
      google.script.run
      .withSuccessHandler(
        function(wikiText, element) {
          clearWikiSpace();
                
            $('#titlepanel').html(wikiText[0][0]);
            $('#datapanel').html(wikiText[1][0]);
            $('#paragraphpanel').html(wikiText[2][0]);
             $('#titlepanel2').html(wikiText[3][0]);
            $('#datapanel2').html(wikiText[4][0]);
            $('#paragraphpanel2').html(wikiText[5][0]);
          element.disabled = false;
          
        }
      )
      .withFailureHandler(
        function(msg, element) {
          showError(msg, $('#wiki-error'));
          element.disabled = false;
        }
      )
      .withUserObject(this)
      .getWikiData($('#key').val(), sourceLangWiki);
    }
    
    function clearWikiSpace(){
      $('#datapanel').html('');
      $('#paragraphpanel').html('');
      $('#titlepanel').html('');
      $('#datapanel2').html('');
      $('#paragraphpanel2').html('');
      $('#titlepanel2').html('');
    }
    
  </script>
</body>
</html>